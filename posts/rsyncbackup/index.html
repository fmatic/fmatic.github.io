<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>rsync snapshot -varmuuskopiointi käytännössä: --link-dest, retention ja sudenkuopat - fmatic's digital playground</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Miksi rsync snapshotteihin?
Moni ajattelee varmuuskopiointia kahdella tavalla:

joko kopioidaan kaikki aina uudestaan
tai luotetaan johonkin mustaan laatikkoon

rsync tarjoaa kolmannen vaihtoehdon:
yksinkertaisen, läpinäkyvän ja tehokkaan snapshot-mallin, joka ei vaadi erikoistyökaluja.

Perusidea lyhyesti
Snapshot-mallissa:

jokainen varmuuskopiointi näyttää täydeltä kopiolta
todellisuudessa vain muuttuneet tiedostot vievät tilaa
muuttumattomat tiedostot ovat kovia linkkejä

Tämä saavutetaan --link-dest-valitsimella.

Hakemistorakenne
Yksi kone, yksi rakenne:
backups/
└── host1/
    ├── 2026-01-05/
    ├── 2026-01-06/
    └── latest -> 2026-01-06/
jokainen päivä on oma snapshot"><meta property="og:image" content><meta property="og:url" content="https://fmatic.github.io/posts/rsyncbackup/"><meta property="og:site_name" content="fmatic's digital playground"><meta property="og:title" content="rsync snapshot -varmuuskopiointi käytännössä: --link-dest, retention ja sudenkuopat"><meta property="og:description" content="Miksi rsync snapshotteihin? Moni ajattelee varmuuskopiointia kahdella tavalla:
joko kopioidaan kaikki aina uudestaan tai luotetaan johonkin mustaan laatikkoon rsync tarjoaa kolmannen vaihtoehdon: yksinkertaisen, läpinäkyvän ja tehokkaan snapshot-mallin, joka ei vaadi erikoistyökaluja.
Perusidea lyhyesti Snapshot-mallissa:
jokainen varmuuskopiointi näyttää täydeltä kopiolta todellisuudessa vain muuttuneet tiedostot vievät tilaa muuttumattomat tiedostot ovat kovia linkkejä Tämä saavutetaan --link-dest-valitsimella.
Hakemistorakenne Yksi kone, yksi rakenne:
backups/ └── host1/ ├── 2026-01-05/ ├── 2026-01-06/ └── latest -> 2026-01-06/ jokainen päivä on oma snapshot"><meta property="og:locale" content="fi_FI"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-07T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-07T00:00:00+00:00"><meta property="article:tag" content="Rsync"><meta property="article:tag" content="Backup"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Snapshots"><meta property="article:tag" content="Homelab"><meta name=twitter:card content="summary"><meta name=twitter:title content="rsync snapshot -varmuuskopiointi käytännössä: --link-dest, retention ja sudenkuopat"><meta name=twitter:description content="Miksi rsync snapshotteihin? Moni ajattelee varmuuskopiointia kahdella tavalla:
joko kopioidaan kaikki aina uudestaan tai luotetaan johonkin mustaan laatikkoon rsync tarjoaa kolmannen vaihtoehdon: yksinkertaisen, läpinäkyvän ja tehokkaan snapshot-mallin, joka ei vaadi erikoistyökaluja.
Perusidea lyhyesti Snapshot-mallissa:
jokainen varmuuskopiointi näyttää täydeltä kopiolta todellisuudessa vain muuttuneet tiedostot vievät tilaa muuttumattomat tiedostot ovat kovia linkkejä Tämä saavutetaan --link-dest-valitsimella.
Hakemistorakenne Yksi kone, yksi rakenne:
backups/ └── host1/ ├── 2026-01-05/ ├── 2026-01-06/ └── latest -> 2026-01-06/ jokainen päivä on oma snapshot"><link rel=stylesheet href=https://fmatic.github.io/css/simple-icons.cc125cfd7958efc8dc27b5dfa6e2a9bbab933ce50b754f77e669e587c16ce857.css type=text/css><link href=https://fmatic.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://fmatic.github.io/css/main.7a5c05040394322612a2d98397e9932aa81d9d7acc70199463e79f8180c8e0c0.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://fmatic.github.io/css/dark.478e7f2b9cf8d87be42edfd9fe1810beab1331847df94b1b430478b309f28282.css></head><body><div class=content><header><div class=main><a href=https://fmatic.github.io/>fmatic's digital playground</a></div><nav><a href=/>Etusivu</a>
<a href=/posts>Blogaukset</a>
<a href=/about>Kuka?</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>rsync snapshot -varmuuskopiointi käytännössä: --link-dest, retention ja sudenkuopat</h1><div class=meta>Posted on Jan 7, 2026</div></div><section class=body><h2 id=miksi-rsync-snapshotteihin>Miksi rsync snapshotteihin?</h2><p>Moni ajattelee varmuuskopiointia kahdella tavalla:</p><ul><li>joko kopioidaan kaikki aina uudestaan</li><li>tai luotetaan johonkin mustaan laatikkoon</li></ul><p><code>rsync</code> tarjoaa kolmannen vaihtoehdon:
<strong>yksinkertaisen, läpinäkyvän ja tehokkaan snapshot-mallin</strong>, joka ei vaadi erikoistyökaluja.</p><hr><h2 id=perusidea-lyhyesti>Perusidea lyhyesti</h2><p>Snapshot-mallissa:</p><ul><li>jokainen varmuuskopiointi näyttää täydeltä kopiolta</li><li>todellisuudessa vain muuttuneet tiedostot vievät tilaa</li><li>muuttumattomat tiedostot ovat <strong>kovia linkkejä</strong></li></ul><p>Tämä saavutetaan <code>--link-dest</code>-valitsimella.</p><hr><h2 id=hakemistorakenne>Hakemistorakenne</h2><p>Yksi kone, yksi rakenne:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>backups/
</span></span><span style=display:flex><span>└── host1/
</span></span><span style=display:flex><span>    ├── 2026-01-05/
</span></span><span style=display:flex><span>    ├── 2026-01-06/
</span></span><span style=display:flex><span>    └── latest -&gt; 2026-01-06/
</span></span></code></pre></div><p>jokainen päivä on oma snapshot</p><ul><li>latest osoittaa viimeisimpään</li><li>palautus on aina helppoa</li></ul><h2 id=ensimmäinen-ajo-täysi-kopio>Ensimmäinen ajo (täysi kopio)</h2><p>Kun aiempaa snapshotia ei ole:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rsync -a --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  /source/ <span style=color:#ae81ff>\ </span>/backups/host1/2026-01-06
</span></span></code></pre></div><p>Tämä kopioi kaiken normaalisti.</p><p>⸻</p><h2 id=seuraavat-ajot-link-dest>Seuraavat ajot (–link-dest)</h2><p>Kun edellinen snapshot on olemassa:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rsync -a --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --link-dest<span style=color:#f92672>=</span>/backups/host1/latest <span style=color:#ae81ff>\ </span>/source/ <span style=color:#ae81ff>\ </span>/backups/host1/2026-01-07/
</span></span></code></pre></div><p>Mitä tapahtuu:</p><ul><li>muuttuneet tiedostot kopioidaan</li><li>muuttumattomat linkitetään</li><li>levytila säästyy</li><li>jokainen snapshot on silti itsenäinen</li></ul><p>⸻</p><h2 id=miksi-delete-on-tärkeä>Miksi –delete on tärkeä</h2><p>Ilman &ndash;delete-valitsinta:</p><ul><li>poistetut tiedostot jäävät kummittelemaan</li><li>snapshot ei vastaa todellista tilannetta</li></ul><p>&ndash;delete varmistaa, että snapshot vastaa lähdejärjestelmän tilaa kyseisenä päivänä.</p><p>⸻</p><h2 id=excludet--kriittinen-osa>Excludet – kriittinen osa</h2><p>Kaikkea ei pidä varmuuskopioida.</p><p>Tyypilliset poissuljettavat:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>--exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;.cache/**&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>--exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/proc/**&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>--exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/sys/**&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>--exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/dev/**&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>--exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/run/**&#39;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>--exclude<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/tmp/**&#39;</span>
</span></span></code></pre></div><p>Erityisesti:</p><ul><li>.cache → turhaa, muuttuu jatkuvasti</li><li>virtuaaliset fs:t → eivät kuulu backupiin</li></ul><p>⸻</p><h2 id=excludestxt--siistimpi-ratkaisu>Excludes.txt – siistimpi ratkaisu</h2><p>Pitkät exclude-listat kannattaa siirtää tiedostoon:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>.cache/**
</span></span><span style=display:flex><span>/proc/**
</span></span><span style=display:flex><span>/sys/**
</span></span><span style=display:flex><span>/dev/**
</span></span><span style=display:flex><span>/run/**
</span></span><span style=display:flex><span>/tmp/**
</span></span></code></pre></div><p>ja käyttää</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rsync -a --delete <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --link-dest<span style=color:#f92672>=</span>... <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  --exclude-from<span style=color:#f92672>=</span>excludes.txt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  /source/ /dest/
</span></span></code></pre></div><p>Tämä tekee skriptistä luettavan ja huollettavan.</p><p>⸻</p><h2 id=retention--vanhojen-snapshotien-siivous>Retention – vanhojen snapshotien siivous</h2><p>Snapshotit eivät ole ikuisia.</p><p>Yksinkertainen retention:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>find /backups/host1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -maxdepth <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -type d <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -name <span style=color:#e6db74>&#34;20*&#34;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -mtime +30 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span>  -exec rm -rf <span style=color:#f92672>{}</span> <span style=color:#ae81ff>\;</span>
</span></span></code></pre></div><p>Tämä:</p><ul><li>säilyttää 30 päivää</li><li>ei koske latest-symlinkkiin</li><li>on helppo ymmärtää</li></ul><h2 id=palautus-on-koko-idean-ydin>Palautus on koko idean ydin</h2><p>Yksittäinen tiedosto:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp /backups/host1/latest/etc/config.conf /etc/config.conf
</span></span></code></pre></div><p>Koko järjestelmä:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rsync -a /backups/host1/latest/ /
</span></span></code></pre></div><p>Ei restore-ohjelmia.
Ei formaatteja.
Ei tulkintaa.</p><p>⸻</p><h2 id=yleiset-sudenkuopat>Yleiset sudenkuopat</h2><p>1️⃣ Unohdetaan –link-dest</p><p>→ kaikki vie täyden tilan</p><p>2️⃣ Snapshotit sekoitetaan</p><p>→ pidä aina yksi kone = yksi hakemisto</p><p>3️⃣ Backup-levy ei ole mountattu</p><p>→ backup menee väärään paikkaan</p><p>Ratkaisu:</p><ul><li>tarkista mountpoint</li><li>keskeytä ajo jos ei ole kiinni</li></ul><p>⸻</p><h2 id=milloin-rsync-ei-riitä>Milloin rsync EI riitä</h2><p>rsync ei ole</p><ul><li>block-level snapshot</li><li>image backup</li><li>ransomware-suoja</li></ul><p>Siksi hyvä malli on:</p><ul><li>rsync snapshotit päivittäin</li><li>full image backup harvemmin (esim. kuukausittain)</li></ul><p>⸻</p><p>Yhteenveto</p><p>rsync snapshot-malli toimii, koska se on:</p><ul><li>yksinkertainen</li><li>läpinäkyvä</li><li>nopea</li><li>helposti palautettava</li></ul><p>Jos ymmärrät:</p><ul><li>&ndash;link-dest</li><li>hyvän hakemistorakenteen</li><li>järkevän retentionin</li></ul><p>…sinulla on varmuuskopiointi, johon voi oikeasti luottaa.</p><p>Ja mikä parasta:</p><p>et tarvitse mitään muuta kuin rsyncin.</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/rsync>rsync</a></li><li><a href=/tags/backup>backup</a></li><li><a href=/tags/linux>linux</a></li><li><a href=/tags/snapshots>snapshots</a></li><li><a href=/tags/homelab>homelab</a></li></ul></nav></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/fmatic rel=me title=GitHub><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#github"/></svg></a><a class=border></a><a class=soc href=https://twitter.com/JanneDX rel=me title=Twitter><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#twitter"/></svg></a><a class=border></a><a class=soc href=https://www.instagram.com/heinikangas rel=me title=Instagram><svg class="feather"><use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#instagram"/></svg></a><a class=border></a><a class=soc href=https://mastodontti.fi/@heinikangas rel=me title=Mastodon><i class="si si-mastodon"></i></a><a class=border></a></div><div class=footer-info>2026 © fmatic | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer></div></body></html>